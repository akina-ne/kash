# 調査レポート: 画像ファイルのパス・名前をデータベースに保存する実装調査

作成日: 2025-11-24

目的:
- アプリケーションで利用する画像ファイルのファイル名とファイルパス（および必要に応じてメタ情報）をデータベースに保存し、アプリ側から参照できるようにする実装方針を検討する。
- 配置する画像ファイルをリポジトリ/静的配信領域に追加し、対応するレコードを DB に登録する手順を整理する。

前提・制約:
- 本ドキュメントは「調査フェーズ」であり、実際のコードや SQL をここで書かない。
- 現在のプロジェクトは Spring Boot を想定する（既存の `nats` プロジェクト構成に合わせる）。
- 開発検証環境は組み込みデータベース（例: H2）やアプリ付属の `schema.sql` / `data.sql` を使う想定。

要件（想定）:
- 画像のファイル名（file_name）とファイルパス（file_path）を保存するテーブル `images` を作成する。
- 画像ファイルはプロジェクト内の静的配信領域（例: `src/main/resources/static/images/`）か、外部のファイル保存領域のいずれかに置く。
- ブラウザから URL 経由で画像にアクセスできること。
- 開発段階では DB に画像そのもの（BLOB）を保存する必要はない（将来の要件次第で検討）。

調査結果サマリ（選択肢と長短）:

1) ファイルシステムに画像を置き、DB にはパスとメタ情報のみを保存（推奨: 開発・検証向け）
   - 長所: 実装が簡単。リポジトリ内の `static/images/` に置けば Spring Boot が自動で配信可能。DB ストレージ使用量が少ない。
   - 短所: ファイルの配置や配信パスの管理が必要。複数インスタンス構成では共有ストレージが必要。

2) DB に BLOB（バイナリ）として画像を保存
   - 長所: データの一貫性を DB で担保できる。バックアップで画像も含めて管理できる。
   - 短所: DB サイズが増える。読み書きの性能や実装コストが増す。ローカル検証では過剰。

3) 外部ストレージ（S3 等）に置き、DB には URL を保存
   - 長所: 本番スケール向け、CDN 配信が容易。
   - 短所: 外部設定・認証が必要。今回の簡易実装では不要。

推奨方針（今回の実装に適した方式）:
- まずは 1) の「プロジェクト内の静的配信領域に画像を置き、DB にはファイル名と相対パスを保存する」方式で実装する。
  - 理由: 実装が短時間で済み、`schema.sql` / `data.sql` による初期データ投入や手動でのファイル追加が容易であるため、検証と動作確認が早く行える。

## 決定事項（今回の実装方針）

- 初期実装: 開発・検証を迅速に行うため、プロジェクト内の静的配信領域（`src/main/resources/static/images/`）に画像を配置し、データベースの `images` テーブルにはファイル名と相対パス（および必要なメタ情報）を保存する方式を採用する。
  - 理由: セットアップと再現性が容易で、既存のセットアップマニュアルとユーザマニュアルに沿って短時間で動作確認できるため。ローカルでの検証やCI環境での自動テストが簡単。

- 本番移行計画（運用要件を満たす段階）:
  1. スケール／可用性／共有が必要になったら、画像格納先をオブジェクトストレージ（例: S3）＋CDN に移行する。DB にはストレージキーまたは公開 URL を保存する。
  2. 移行時はアプリ設定でベース URL を切替可能にし、必要に応じて DB 内のパスを変換するマイグレーションスクリプトを用意する。
  3. 認可が必要な画像については署名付き URL や認可ゲートを検討する。
  4. バックアップ、監査、キャッシュ制御（Cache-Control／ETag）、アクセス権限の運用ルールを整備する。

- 優先タスク（短期）:
  - `src/main/resources/schema.sql` に `images` テーブル定義を追記する。
  - `src/main/resources/static/images/` にサンプル画像を追加する。
  - 必要に応じて `src/main/resources/data.sql` に初期レコードを追加する。
  - アプリ側で DB のレコードから画像 URL を生成して表示する簡易機能（Controller/テンプレート）を実装し、動作確認を行う。

- 注意点:
  - リポジトリに大容量・更新頻度の高い画像を入れると履歴が肥大化するので、頻繁に変更する画像は外部ストレージに移行すること。
  - 複数インスタンス構成ではローカル filesystem に依存しない運用へ早めに移行することを推奨する。

データ項目（例、設計指針・コードは書かない）:
- id (主キー)
- file_name （表示用のファイル名、例: myphoto.jpg）
- file_path （静的配信からの相対パス、例: /static/images/myphoto.jpg、もしくは images/myphoto.jpg）
- content_type （image/jpeg 等、任意）
- created_at / updated_at （任意）

対象となるファイル（ワークスペースのルートからの相対パス）:
- src/main/resources/schema.sql （テーブル定義を置く場所。プロジェクトで既に schema.sql がある場合は追記）
- src/main/resources/data.sql （初期データを投入する場合）
- src/main/resources/static/images/ （実際の画像ファイルを配置するディレクトリ）
- src/main/java/.../entity/Image.java （将来的に JPA を使う場合のエンティティ）
- src/main/java/.../repository/ImageRepository.java （JPA リポジトリ）
- src/main/java/.../controller/ImageController.java （画像一覧や参照用のエンドポイント）
- docs/tasks.md （実装フェーズに移る場合はここにタスクを記載すること）

実装手順（概要、コードはここでは記載しない）:
1. `docs/tasks.md` に本タスクを作成し、実装手順と DoD を記載する（調査フェーズのルール）。
2. main ブランチにいることを確認し、新しいブランチを作成する（例: feat/add-images-table）。
3. `schema.sql` に `images` テーブル定義を追加する（開発用は主キーと file_name, file_path を最低限設ける）。
4. プロジェクトの `src/main/resources/static/images/` に実際に使用する画像ファイルを追加する。
5. 必要なら `data.sql` にサンプルレコードを追加してアプリ起動時に投入する。
6. アプリを起動して（`./gradlew bootRun` 等）、ブラウザで画像の URL にアクセスできることを確認する。
7. 将来的に管理画面から画像をアップロードする場合は、ImageController とアップロード処理、サービス層、JPA を追加する。

検証方法（DoD: Definition of Done）:
- `./gradlew bootRun` でアプリを起動できること。
- `src/main/resources/static/images/` に追加した画像ファイルがブラウザ経由で表示できること（例: http://localhost:8080/images/xxx.jpg のようなパスでアクセス）。
- データベースに `images` テーブルが作成され、少なくとも 1 件のレコードが file_name と file_path を持っていること（`data.sql` を使うか、起動後に確認）。
- アプリから DB のレコードを読み取り、画像 URL を生成して表示できること（手動確認で可）。

参考リンク:
- Spring Boot 公式: Static Content の配置と自動配信に関するドキュメント
- Spring のファイルアップロードと保存に関する記事（外部ストレージや BLOB と比較した解説）

次のアクション候補:
1. この調査結果に基づいて実装を進めてほしい -> 「実装」を指示してください（その場合は `docs/tasks.md` にタスクを記載し、実装フェーズの手順に従います）。
2. BLOB 保存や外部ストレージ（S3 等）での運用を検討したい -> 要件（スケール、共有ストレージの有無、バックアップ方針等）を提示してください。

作業報告:
- このファイルには、画像ファイルをプロジェクト内に配置してそのファイル名とファイルパスを DB に保存するための選択肢、推奨方針、対象ファイル、実装手順、DoD をまとめた。
- 次にユーザが取れる行動: 実装を開始する場合は「実装」と指示してください。
