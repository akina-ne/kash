<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">

<head>
  <meta charset="UTF-8" />
  <title>画像の森/GameStart</title>
  <style>
    .modal {
      position: relative;
      width: 60%;
      min-width: 280px;
      display: flex;
      align-items: center;
      justify-content: center;
      background: transparent;
      z-index: 10;
      visibility: visible;
      opacity: 1;
      transition: none;
    }

    .modal img {
      max-width: 100%;
      max-height: 70vh;
      transition: transform 120ms linear, opacity 150ms ease;
      transform: scale(1.8);
      opacity: 0;
      box-shadow: 0 8px 24px rgba(0, 0, 0, 0.5);
      border-radius: 6px;
      background: #fff;
    }

    .modal img.final {
      transform: scale(1);
      opacity: 1;
    }

    .show-button {
      padding: 6px 10px;
      font-size: 14px;
      cursor: pointer;
      border: 1px solid #666;
      background: #f0f0f0;
      border-radius: 4px;
    }

    .row {
      display: flex;
      gap: 12px;
      flex-wrap: wrap;
      margin: 12px 0;
    }

    .card {
      border: 1px solid #ddd;
      border-radius: 6px;
      padding: 8px;
      width: 260px;
    }

    .msg {
      margin: .5rem 0;
    }

    /* レイアウト: 左=フォーム(50%)、右=画像スペース(50%) */
    .layout {
      display: flex;
      gap: 0;
      align-items: stretch;
      flex-wrap: nowrap;
      height: 78vh;
      /* ウィンドウに合わせて領域を確保 */
    }

    /* フォーム領域（左） */
    .form-area {
      /* 表示順を右側(2)にするため order:2 を指定（HTMLはそのまま） */
      flex: 0 0 30%;
      max-width: 30%;
      order: 2;
      padding: 20px;
      box-sizing: border-box;
      overflow: auto;
      background: #fff;
    }

    /* 画像領域（右） */
    .image-area {
      /* 表示順を左側(1)にするため order:1 を指定 */
      flex: 0 0 70%;
      max-width: 70%;
      order: 1;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 20px;
      box-sizing: border-box;
      background: #ffffff;
      position: relative;
      overflow: hidden;
    }

    /* 画像領域内のモーダルはコンテナいっぱいに広げる */
    .image-area .modal {
      width: 100%;
      height: 100%;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .image-area .modal img {
      max-width: 100%;
      max-height: 100%;
      transform-origin: 50% 50%;
      will-change: transform, opacity;
      display: block;
      pointer-events: auto;
    }

    /* 送信ボタンのスタイル（ここを調整してボタンの大きさを変更） */
    .submit-button {
      padding: 12px 20px;
      /* 縦・横の内側余白 */
      font-size: 18px;
      /* 文字サイズ（ボタンの見た目に影響） */
      min-width: 110px;
      /* 最小横幅 */
      border-radius: 6px;
      border: 1px solid #666;
      background: #f0f0f0;
      cursor: pointer;
    }

    /* 〇 / ✕ 表示用の全画面オーバーレイ */
    .judge-overlay {
      position: fixed;
      inset: 0;
      background: rgba(255, 255, 255, 0.8);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 9999;
    }

    .judge-overlay.show {
      display: flex;
    }

    .judge-mark {
      font-size: 20vw;
      font-weight: bold;
    }

    .judge-mark.correct {
      color: #00aa00;
    }

    .judge-mark.wrong {
      color: #cc0000;
    }
  </style>
</head>

<body th:attr="data-initial-image=${initialImage}">
  <!-- ページ上部に経過秒を表示 -->
  <div id="elapsedTime"
    style="position:fixed;top:10px;left:50%;transform:translateX(-50%);background:#fff;padding:6px 10px;border-radius:6px;box-shadow:0 2px 6px rgba(0,0,0,0.15);z-index:1000;font-weight:600;">
    経過: 0秒</div>
  <h1>Game</h1>

  <!-- 〇/✕ オーバーレイ -->
  <div id="judgeOverlay" class="judge-overlay">
    <div id="judgeMark" class="judge-mark"></div>
  </div>

  <div class="msg" th:if="${error}" style="color:red;">[[${error}]]</div>
  <div class="msg" th:if="${resultMsg}" style="color:blue;">[[${resultMsg}]]</div>
  <div class="msg" th:if="${saved}" style="color:green;"></div>

  <!-- レイアウト: 左に画像ズーム、右にフォーム -->
  <div class="layout">
    <!-- 左: 回答フォーム（50%） -->
    <div class="form-area">
      <form id="answerForm" th:action="@{/game/answer}" th:object="${answerForm}" method="post" style="margin-top:0;">
        <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />

        <!-- ★ 出題中の画像IDを AnswerForm.imageId に渡す -->
        <input type="hidden" name="imageId" th:value="${questionImage != null} ? ${questionImage.id} : null" />

        <h2>回答フォーム</h2>
        <!-- ★ ラベルをひらがな前提に変更 -->
        <label for="content">回答（ひらがなで入力してください）</label><br />
        <textarea id="content" th:field="*{content}" rows="12" cols="40" maxlength="1000" required></textarea>
        <div style="margin-top:8px;"><button type="submit" class="submit-button">送信</button></div>

      </form>
    </div>

    <!-- 右: 画像スペース（50%） -->
    <div class="image-area">
      <div id="imgModal" class="modal" onclick="closeModal(event)">
        <img id="modalImage" src="" alt="画像" />
      </div>
    </div>
  </div>

  <script>
    var ZOOM_INITIAL = 1.0; // images.html と同じ
    var ZOOM_DURATION = 30000; // images.html と同じ
    var REDIRECT_URL = '/ranking';
    var MAX_INITIAL_SCALE = 12; // 破損防止の上限を設定
    // 経過タイマー用の変数
    var gameStartTime = null;
    var elapsedIntervalId = null;

    function clearExistingAnimation(imgEl) {
      var rafId = imgEl && imgEl.dataset && imgEl.dataset.rafId;
      if (rafId) { cancelAnimationFrame(Number(rafId)); delete imgEl.dataset.rafId; }
    }
    function easeOutCubic(t) { return 1 - Math.pow(1 - t, 3); }

    function showZoom(button) {
      // ズーム開始時（ゲーム開始）に経過タイマを開始
      if (!gameStartTime) startElapsedTimer();
      var src = button.getAttribute('data-src');
      var buttonScale = Number(button.getAttribute('data-initial-scale')) || ZOOM_INITIAL;
      var initialScale = Math.min(buttonScale, MAX_INITIAL_SCALE); // 上限を適用
      var modal = document.getElementById('imgModal');
      var modalImg = document.getElementById('modalImage');

      clearExistingAnimation(modalImg);
      modalImg.classList.remove('final');
      modalImg.style.transformOrigin = '50% 50%';
      modalImg.style.transform = 'scale(' + initialScale + ')';
      modalImg.style.opacity = 0;

      modalImg.onload = function () {
        var start = null;
        var duration = ZOOM_DURATION;
        modalImg.style.opacity = 1;

        function step(timestamp) {
          if (!start) start = timestamp;
          var elapsed = timestamp - start;
          var progress = Math.min(elapsed / duration, 1);
          var eased = easeOutCubic(progress);
          var currentScale = initialScale - (initialScale - 1) * eased;
          modalImg.style.transform = 'scale(' + currentScale + ')';
          if (progress < 1) {
            var rafId = requestAnimationFrame(step);
            modalImg.dataset.rafId = String(rafId);
          } else {
            modalImg.style.transform = 'scale(1)';
            delete modalImg.dataset.rafId;

            // アニメーション完了時の遷移（複数問のため無効化）
            // stopElapsedTimer();
            // window.location.href = REDIRECT_URL;
          }
        }
        var rafId = requestAnimationFrame(step);
        modalImg.dataset.rafId = String(rafId);
      };

      modalImg.onerror = function () {
        modalImg.alt = '画像を読み込めませんでした';
        modalImg.style.opacity = 1;
      };

      modal.classList.add('open');
      try { modalImg.removeAttribute('src'); } catch (e) { modalImg.src = ''; }
      requestAnimationFrame(function () { modalImg.src = src; });
    }

    function closeModal(event) {
      var modal = document.getElementById('imgModal');
      var modalImg = document.getElementById('modalImage');
      if (event && event.target === modalImg) return;
      clearExistingAnimation(modalImg);
      modalImg.classList.remove('final');
      modal.classList.remove('open');
      setTimeout(function () {
        modalImg.src = '';
        modalImg.style.opacity = 0;
        modalImg.style.transform = '';
      }, 200);
      // モーダルを閉じたらタイマを停止
      stopElapsedTimer();
      setTimeout(function () { modalImg.src = ''; modalImg.style.opacity = 0; modalImg.style.transform = ''; }, 200);
    }

    document.addEventListener('keydown', function (e) {
      if (e.key === 'Escape') {
        var modal = document.getElementById('imgModal');
        if (modal.classList.contains('open')) closeModal();
      }
    });

    // --- static/images にファイルがあるかを確認する既存処理 ---
    // 経過時間表示の更新と開始/停止用関数
    function updateElapsedDisplay() {
      var el = document.getElementById('elapsedTime');
      if (!el || !gameStartTime) return;
      var msTotal = Date.now() - gameStartTime;
      var s = Math.floor(msTotal / 1000);
      var msRem = msTotal % 1000;
      // 表示を ss.fff 形式に整形（秒は最低2桁、ミリ秒は3桁）
      var secStr = String(s).padStart(2, '0');
      var msStr = String(msRem).padStart(3, '0');
      el.textContent = '経過: ' + secStr + '.' + msStr + '秒';
    }
    function startElapsedTimer() {
      // 常にリセットしてスタート
      gameStartTime = Date.now();
      updateElapsedDisplay();
      if (elapsedIntervalId) clearInterval(elapsedIntervalId);
      elapsedIntervalId = setInterval(updateElapsedDisplay, 50); // 50ms 更新で .fff 表示を滑らかに
    }
    function stopElapsedTimer() {
      if (elapsedIntervalId) { clearInterval(elapsedIntervalId); elapsedIntervalId = null; }
      try { localStorage.removeItem('gameStartTime'); } catch (e) { }
      gameStartTime = null;
      // 最終表示をクリアまたはそのまま残すかは要件次第。ここでは '経過: 0.000秒' に戻す
      var el = document.getElementById('elapsedTime');
      if (el) el.textContent = '経過: 00.000秒';
    }

    // ページ読み込み時に localStorage に開始時刻があればタイマを再開する
    (function resumeTimerIfNeeded() {
      try {
        var stored = localStorage.getItem('gameStartTime');
        if (stored) {
          // タイマを開始（既に開始済みであれば startElapsedTimer 内で適切に処理される）
          startElapsedTimer(stored);
        }
      } catch (e) { }
    })();

    // --- 追加: static/images にファイルがあるかを確認し、存在するなら「画像がありません」メッセージとデフォルトボタンを非表示にする ---
    (function checkStaticImages() {
      var candidates = ['/images/onigiri.jpg', '/images/kinkakuji.jpg'];
      var found = false;
      var remaining = candidates.length;

      function hideNoImages() {
        var d = document.getElementById('noImagesDiv');
        if (d) d.style.display = 'none';
      }

      candidates.forEach(function (url) {
        var img = new Image();
        img.onload = function () {
          found = true;
          hideNoImages();
        };
        img.onerror = function () {
          remaining--;
          if (remaining === 0 && !found) {
            // どれも存在しない場合はそのまま表示（何もしない）
          }
        };
        setTimeout(function () { img.src = url; }, 0);
      });
    })();

    // ★ 送信フォームを非同期送信にする処理＆初期ズーム起動
    document.addEventListener('DOMContentLoaded', function () {
      // 非同期送信
      var form = document.getElementById('answerForm');
      if (form) {
        form.addEventListener('submit', function (e) {
          e.preventDefault(); // ページリロードを防ぐ

          var formData = new FormData(form);
          var csrfInput = form.querySelector('input[name="_csrf"]');
          var csrfToken = csrfInput ? csrfInput.value : null;

          fetch(form.getAttribute('action'), {
            method: 'POST',
            headers: csrfToken ? { 'X-CSRF-TOKEN': csrfToken } : {},
            body: formData
          })
            .then(function (res) { return res.json(); })
            .then(function (data) {
              handleAnswerResponse(data);
            })
            .catch(function (err) {
              console.error('回答送信エラー', err);
              alert('送信中にエラーが発生しました');
            });
        });
      }

      // Enterキーで送信（通常の改行は不要、Enterで1ワード送信する想定）
      var textarea = document.getElementById('content');
      if (textarea && form) {
        // ★ ページ表示直後にフォームへフォーカス
        textarea.focus();

        textarea.addEventListener('keydown', function (e) {
          // Enter 押下で送信（Shift/Alt/Ctrl 等複合キーは無視して Enter 単独のみ）
          if (e.key === 'Enter' && !e.shiftKey && !e.ctrlKey && !e.altKey && !e.metaKey) {
            e.preventDefault(); // 改行を防ぐ
            // 既存の submit ハンドラを通すために submit イベントを発火
            form.dispatchEvent(new Event('submit', { bubbles: true, cancelable: true }));
          }
        });
      }

      // ページ読み込み時にサーバ側で選ばれた画像で自動ズーム開始
      var initial = document.body && document.body.dataset && document.body.dataset.initialImage;
      var imgSrc = initial || '/images/onigiri.jpg';
      var fakeButton = {
        getAttribute: function (name) {
          if (name === 'data-src') return imgSrc;
          if (name === 'data-initial-scale') return '12';
          return null;
        }
      };
      showZoom(fakeButton);
    });

    // ★ サーバ応答に応じて 〇 / ✕ を表示する
    function handleAnswerResponse(data) {
      if (!data) {
        alert('サーバからの応答が不正です');
        return;
      }

      // バリデーションやエラー時
      if (data.success === false && data.error) {
        alert(data.error);
        return;
      }

      if (data.success === true) {
        var overlay = document.getElementById('judgeOverlay');
        var mark = document.getElementById('judgeMark');
        if (!overlay || !mark) {
          // 万一オーバーレイが無い場合はフォールバック
          alert(data.message || (data.correct ? '正解です！' : '不正解です'));
          if (data.correct) {
            window.location.href = REDIRECT_URL;
          }
          return;
        }

        mark.classList.remove('correct', 'wrong');

        if (data.correct) {
          mark.textContent = '〇';
          mark.classList.add('correct');
          overlay.classList.add('show');

          var nextUrl = (data.redirectTo) ? String(data.redirectTo) : REDIRECT_URL;

          setTimeout(function () {
            window.location.href = nextUrl;
          }, 2000);
        } else {
          // 不正解：大きな✕を表示 → 2 秒後にオーバーレイだけ消し、そのまま滞在
          mark.textContent = '✕';
          mark.classList.add('wrong');
          overlay.classList.add('show');
          setTimeout(function () {
            overlay.classList.remove('show');
          }, 2000);
        }
      }
    }
  </script>
</body>

</html>
