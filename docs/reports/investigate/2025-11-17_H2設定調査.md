# 2025-11-17 H2データベース設定調査

目的
- Spring Boot プロジェクトで H2 を用いたデータベースを構築する手順を調査する。
- 要件：DB の接続ユーザ名を `kash`、パスワードを `nats` にする。
- 参照リポジトリ：igakilab/springboot_samples（参考に実装方法を確認）。

調査結果（要点）
1. 依存関係
   - Gradle の場合、以下の依存を追加する必要がある。
     - `org.springframework.boot:spring-boot-starter-data-jpa`
     - `com.h2database:h2`

2. datasource の設定（application.properties / application.yml）
   - 基本（インメモリ）例:

     spring.datasource.url=jdbc:h2:mem:kashdb;DB_CLOSE_DELAY=-1;DB_CLOSE_ON_EXIT=FALSE
     spring.datasource.username=kash
     spring.datasource.password=nats
     spring.datasource.driver-class-name=org.h2.Driver
     spring.jpa.hibernate.ddl-auto=update
     spring.h2.console.enabled=true
     spring.h2.console.path=/h2-console

   - ファイル永続化（開発中にデータを保持したい場合）例:

     spring.datasource.url=jdbc:h2:file:./data/kashdb;AUTO_SERVER=TRUE
     spring.datasource.username=kash
     spring.datasource.password=nats

3. 初期スキーマ/データの投入方法
   - `src/main/resources/schema.sql` と `src/main/resources/data.sql` を用意すれば Spring Boot が自動で実行する（デフォルト設定時）。
   - もしくは、JPA の Entity を作成して `spring.jpa.hibernate.ddl-auto` を `update` または `create` に設定する方法。

4. H2 コンソールへのアクセス
   - デフォルトで /h2-console を有効にするとブラウザから確認可能。
   - ログイン時の JDBC URL、ユーザ名、パスワードは application.properties の設定と一致させること。
   - 起動後、ブラウザで http://localhost:8080/h2-console にアクセス → Driver: org.h2.Driver、JDBC URL 例：jdbc:h2:mem:kashdb、User: kash、Password: nats

5. Spring Security を使っている場合の注意点
   - アプリが Spring Security を利用していると H2 コンソールへアクセスできないことがある。
   - 対処例（SecurityConfig）：
     - `/h2-console/**` へのアクセスを許可する
     - CSRF を H2 コンソール時に無効にする（または適切に設定する）
     - フレーム表示を許可するために `http.headers().frameOptions().sameOrigin()` を設定する

6. igakilab/springboot_samples の参照ポイント
   - リポジトリ: https://github.com/igakilab/springboot_samples
   - サンプルから学べる点：Spring Boot のプロパティ設定例、セキュリティ設定例、JPA と初期データ投入のパターン。
   - （実際の該当ファイルはリポジトリ内の `spring-data-jpa` や `security` に相当するサンプルを参照）

推奨手順（実装前の提案）
1. `build.gradle` に依存を追加する
2. `application.properties` に上記の接続情報（ユーザ名: `kash`, パスワード: `nats`）を追記
3. H2 コンソールを有効化し、`/h2-console` にアクセスできるか確認する
4. Spring Security を使用している場合は `SecurityConfig` を調整してコンソールへのアクセスを許可する
5. 必要なら `schema.sql` / `data.sql` で初期データを投入する、または JPA Entity を作成して `ddl-auto` を適切に設定する

セキュリティ上の注意
- 開発環境以外で H2 コンソールを有効にしておくとセキュリティリスクがあるため、本番環境では無効化すること。
- パスワードは開発でも平文で置かない運用（環境変数、Vault 等）を検討すること。

参考URL
- https://github.com/igakilab/springboot_samples
- H2 ドキュメント: https://www.h2database.com/html/main.html
- Spring Boot のデータベース設定: https://docs.spring.io/spring-boot/docs/current/reference/htmlsingle/#data.sql

作業報告（本調査で行ったこと）
- H2 を Spring Boot プロジェクトで利用するための必要事項を整理し、`kash/nats` を用いる具体的な設定例を提示した。

次にユーザーが取れる行動
- 実装フェーズに進む場合は「計画」指示を出してください。計画フェーズでは `docs/tasks.md` に実装タスクをまとめます。
- すぐに実装を希望する場合は、main ブランチの確認→新規ブランチ作成→実装の順で進めます（実装は別フェーズ）。
