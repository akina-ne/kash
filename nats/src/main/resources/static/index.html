<!DOCTYPE html>
<html>

<head>
  <meta charset="UTF-8">
  <title>画像の森</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <style>
    body {
      font-family: sans-serif;
      margin: 1rem;
    }

    h1 {
      margin-top: 0;
    }

    ol {
      padding-left: 1.4rem;
    }

    .count {
      font-weight: bold;
      margin-bottom: .5rem;
    }

    /* 追加: 表示ボタンのスタイル */
    .show-images-button {
      display: none;
      margin: 0.5rem 0 1rem 0;
      padding: 8px 12px;
      background: #2d7cff;
      color: #fff;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 14px;
    }

    /* カードスタイル */
    .player-card {
      min-width: 140px;
      padding: 12px 16px;
      border-radius: 10px;
      background: #f5f7ff;
      box-shadow: 0 2px 6px rgba(0, 0, 0, 0.08);
      text-align: center;
    }

    /* 1P強調スタイル */
    .player-card.highlight {
      border: 2px solid #2d7cff;
      background: #eaf0ff;
    }

    /* 中央寄せスタイル */
    .center-container {
      display: flex;
      flex-direction: column;
      align-items: center;
    }

    /* カウントダウンオーバーレイ */
    .overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.6);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 9999;
      visibility: hidden;
      opacity: 0;
      transition: opacity .18s ease, visibility .18s ease;
    }

    .overlay.visible {
      visibility: visible;
      opacity: 1;
    }

    .overlay .countdown {
      font-size: 96px;
      color: #fff;
      font-weight: 700;
      text-align: center;
      padding: 24px 40px;
      border-radius: 12px;
      background: rgba(0, 0, 0, 0.3);
      box-shadow: 0 6px 18px rgba(0, 0, 0, 0.4);
    }
  </style>
</head>

<body>
  <h1>入室者（入った順）</h1>
  <!-- 追加: 画像表示ページへ移動するボタン -->
  <button class="show-images-button" id="openImagesBtn">開始</button>
  <div id="count" class="count"></div>
  <ol id="list"></ol>
  <p><a href="/logout">Logout</a></p>
  <script>
    const render = (data) => {
      // /api/online から { users: [...], currentUser: "..." } が返る想定
      const users = data.users || [];
      const currentUser = data.currentUser;

      // エスケープ用ヘルパー（簡易）
      const escapeHtml = (str) => String(str)
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;')
        .replace(/\"/g, '&quot;')
        .replace(/'/g, '&#39;');

      // 参加人数表示は既存の要素を利用
      const countEl = document.getElementById('count');
      countEl.textContent = '参加人数: ' + users.length + '人';

      // 古いリスト要素は非表示にして、代わりにカード領域を挿入
      const listEl = document.getElementById('list');
      listEl.style.display = 'none';

      // cardsArea を作成または再利用
      let cardsArea = document.getElementById('cardsArea');
      if (!cardsArea) {
        cardsArea = document.createElement('div');
        cardsArea.id = 'cardsArea';
        // カード領域を list の直後に挿入
        listEl.parentNode.insertBefore(cardsArea, listEl.nextSibling);
      }

      // カードのラッパー
      const cardsWrapper = document.createElement('div');
      cardsWrapper.style.display = 'flex';
      cardsWrapper.style.flexWrap = 'wrap';
      cardsWrapper.style.justifyContent = 'center';
      cardsWrapper.style.gap = '12px';
      cardsWrapper.style.marginTop = '8px';

      users.forEach((u, i) => {
        const card = document.createElement('div');
        card.className = 'player-card';
        card.style.minWidth = '140px';
        card.style.padding = '12px 16px';
        card.style.borderRadius = '10px';
        card.style.background = '#f5f7ff';
        card.style.boxShadow = '0 2px 6px rgba(0,0,0,0.08)';
        card.style.textAlign = 'center';

        // 自分（currentUser）を視覚的に強調
        if (currentUser && u === currentUser) {
          card.style.border = '2px solid #2d7cff';
          card.style.background = '#eaf0ff';
          card.classList.add('highlight');
        }

        card.innerHTML = `
          <div style="font-weight:700;">${i + 1}P</div>
          <div style="margin-top:6px;word-break:break-all;">${escapeHtml(u)}</div>
        `;
        cardsWrapper.appendChild(card);
      });

      // カード領域に反映
      cardsArea.innerHTML = '';
      // 中央フォーカス用コンテナ
      const centerContainer = document.createElement('div');
      centerContainer.className = 'center-container';
      centerContainer.appendChild(cardsWrapper);
      cardsArea.appendChild(centerContainer);

      // 開始ボタン表示／スタイル制御
      const openBtn = document.getElementById('openImagesBtn');
      // 大きく中央に見せるスタイル
      openBtn.style.padding = '14px 28px';
      openBtn.style.fontSize = '18px';
      openBtn.style.borderRadius = '28px';
      openBtn.style.background = '#2d7cff';
      openBtn.style.color = '#fff';
      openBtn.style.border = 'none';
      openBtn.style.boxShadow = '0 6px 18px rgba(45,124,255,0.25)';
      openBtn.style.cursor = 'pointer';
      openBtn.style.transition = 'transform .12s ease';
      openBtn.onmouseover = () => (openBtn.style.transform = 'scale(1.04)');
      openBtn.onmouseout = () => (openBtn.style.transform = 'scale(1)');
      openBtn.style.display = 'block';
      openBtn.style.margin = '16px auto 0 auto';

      // 表示可否は従来どおり 1P のみ
      if (users.length > 0 && currentUser && users[0] === currentUser) {
        openBtn.style.visibility = 'visible';
      } else {
        openBtn.style.visibility = 'hidden';
      }
    };

    const load = async () => {
      const r = await fetch('/api/online');
      const data = await r.json();
      render(data);
    };
    load();
    setInterval(load, 10000);

    /**
     * ゲーム開始APIを呼び出す関数.
     * 既存: 即時開始用（互換性のため残す）
     */
    function requestStartGame() {
      fetch('/api/game/start', {
        method: 'POST'
      }).then(function (response) {
        if (!response.ok) {
          console.error('ゲーム開始APIの呼び出しに失敗しました');
        }
        return response.json();
      }).catch(function (error) {
        console.error('ゲーム開始API呼び出し時にエラーが発生しました', error);
      });
    }

    /**
     * サーバーに対してカウントダウン開始を要求する（1Pがボタンを押したとき）
     */
    function requestStartCountdown() {
      const openBtn = document.getElementById('openImagesBtn');
      if (openBtn) openBtn.disabled = true;
      fetch('/api/game/start-countdown', {
        method: 'POST'
      }).then(function (response) {
        if (!response.ok) {
          console.error('カウントダウン開始APIの呼び出しに失敗しました');
          if (openBtn) openBtn.disabled = false;
        }
        return response.json();
      }).catch(function (error) {
        console.error('カウントダウン開始API呼び出し時にエラーが発生しました', error);
        if (openBtn) openBtn.disabled = false;
      });
    }

    /**
     * ゲーム開始状態をポーリングで確認し、開始されていれば /game にリダイレクトする.
     * また remainingMillis を参照してカウントダウンオーバーレイを表示する.
     */
    function startGameStatusPolling() {
      var pollingIntervalMillis = 250; // 高頻度でポーリングしてカウントダウンを滑らかに表示
      var intervalId = setInterval(function () {
        fetch('/api/game/status')
          .then(function (response) {
            if (!response.ok) {
              console.error('ゲーム状態取得APIの呼び出しに失敗しました');
            }
            return response.json();
          })
          .then(function (data) {
            if (!data) return;

            // カウントダウン残りミリ秒がある場合、オーバーレイを表示
            var remaining = data.remainingMillis || 0;
            var overlay = document.getElementById('countdownOverlay');

            if (remaining > 0) {
              // 残り秒を切り上げで表示（例: 2500ms -> 3）
              var seconds = Math.ceil(remaining / 1000);
              if (!overlay) {
                overlay = document.createElement('div');
                overlay.id = 'countdownOverlay';
                overlay.className = 'overlay';
                overlay.innerHTML = '<div class="countdown">' + seconds + '</div>';
                document.body.appendChild(overlay);
              }
              var countdownEl = overlay.querySelector('.countdown');
              if (countdownEl) countdownEl.textContent = String(seconds);
              overlay.classList.add('visible');
            } else {
              // 残り0の場合はオーバーレイ非表示
              if (overlay) {
                overlay.classList.remove('visible');
                setTimeout(function () {
                  if (overlay && overlay.parentNode) overlay.parentNode.removeChild(overlay);
                }, 250);
              }
            }

            // 開始フラグが立ったらページ遷移
            if (data.started === true) {
              clearInterval(intervalId);
              window.location.href = '/game';
            }
          })
          .catch(function (error) {
            console.error('ゲーム状態取得API呼び出し時にエラーが発生しました', error);
          });
      }, pollingIntervalMillis);
    }

    // ページ読み込み完了時の初期化処理
    document.addEventListener('DOMContentLoaded', function () {
      // 「開始」ボタンにクリックイベントを設定
      var startButton = document.getElementById('openImagesBtn');
      if (startButton) {
        startButton.addEventListener('click', function () {
          // 1Pはサーバーのカウントダウン開始APIを呼ぶ
          requestStartCountdown();
        });
      }

      // ページ表示中の全ユーザーでゲーム開始状態をポーリング
      startGameStatusPolling();
      playBgm('Demo1.mp3');
    });
    // ===== BGM 関連 =====
    // ページごとに 1 つの BGM を管理するための Audio インスタンス
    var bgmAudio = null;

    /**
     * 指定されたファイル名の BGM をループ再生する
     * 例: playBgm('game.mp3') -> /bgm/game.mp3 を再生
     */
    function playBgm(bgmFileName) {
      // すでに再生中なら止める
      if (bgmAudio) {
        try {
          bgmAudio.pause();
        } catch (e) { }
        bgmAudio = null;
      }

      if (!bgmFileName) {
        return;
      }

      var src = '/bgm/' + bgmFileName;
      var audio = new Audio(src);
      audio.loop = true;

      // 自動再生ブロック対策: 再生エラーを握りつぶしてコンソールにだけ出す
      audio.play().catch(function (err) {
        console.warn('BGM 再生がブロックされました: ', err);
      });

      bgmAudio = audio;
    }

    /**
     * 現在の BGM を停止する
     */
    function stopBgm() {
      if (bgmAudio) {
        try {
          bgmAudio.pause();
        } catch (e) { }
        bgmAudio = null;
      }
    }
  </script>

</body>

</html>
