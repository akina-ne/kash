# レビュー報告書: ログイン実装（in-memory / kash）

作成日: 2025-11-11

対象:
- `nats/src/main/java/team2/nats/config/SecurityConfig.java`
- `docs/specs.md`
- `docs/tasks.md`

要約:
- 実装は `BCryptPasswordEncoder` を用い in-memory でユーザ `kash` を登録しており、機能的には要件に沿っている。
- ただしセキュリティ運用上の懸念（ソース中の平文パスワード）と静的資源の公開設定不足があるため、修正を推奨する。

重要な指摘事項（優先度順）:
1. 平文パスワードがソースに残っている（優先度: 高）
   - 現状: `passwordEncoder.encode("nats")` によりソースに平文 `nats` が記載されている。
   - リスク: リポジトリ漏洩時にパスワードが容易に分かる。
   - 推奨対応 (選択肢・実装手順):
     a) 事前に BCrypt ハッシュを生成し、コード内でハッシュ文字列を直接使用する（例: `.password("$2a$...")`）。
     b) 環境変数または `application.properties`（ローカル開発のみ）からパスワードまたはハッシュを読み込む。
     c) 開発方針として in-memory は短期利用に限定し、平文をコミットしない運用ルールを徹底する（暫定）。
   - 優先対応: a) か b) のいずれかを実施すること。

2. 静的資源・公開エンドポイントの許可設定がない（優先度: 中）
   - 現状: `authorizeHttpRequests` が `anyRequest().authenticated()` のみで設定されている。
   - リスク: ログイン画面やアセットが正しく表示されない可能性がある。
   - 推奨対応: 以下を許可する設定を追加する。
     - `/css/**`, `/js/**`, `/images/**`, `/favicon.ico`, `/error` など。
     - デフォルトのログインページは Spring が提供するため通常は表示されるが、明示的に許可することを推奨。

3. 起動・動作確認が未実施（優先度: 低）
   - 実施内容: `./gradlew build`、`./gradlew bootRun` による起動確認とブラウザでのログイン確認（`kash`/`nats`）。

具体的な修正例（実装概要）:
- SecurityConfig の変更点
  - パスワード設定を以下のいずれかに置き換える。
    - ハッシュを直接使用: `.password("$2a$...precomputed-hash...")`
    - 環境変数を利用: `String pass = env.getProperty("APP_ADMIN_PW"); .password(passwordEncoder.encode(pass))`（ただし平文がメモリに残る点に注意）
  - 認可設定を明示的に変更:
    - `.authorizeHttpRequests(auth -> auth.requestMatchers("/css/**","/js/**","/images/**","/favicon.ico","/error").permitAll().anyRequest().authenticated())`

レビューチェックリスト（現状）:
- [x] BCrypt を使用している
- [x] in-memory で `kash` を登録している
- [ ] 平文パスワードがコードに残っていない（未対応）
- [ ] 静的資源の permitAll 設定が追加されている（未対応）
- [x] デフォルトログイン画面を使用している

推奨される次のアクション（短く）:
- 早急に「平文パスワードを事前計算済みの BCrypt ハッシュに置換」し、同時に「静的資源を permitAll に追加」すること。
- 私が修正を行ってよい場合は「実装開始」とだけ指示してください。修正は新ブランチで行い、動作確認と完了レポートを作成します。

備考:
- 本リポジトリは学習/演習用途と見受けられるため、開発便利性とセキュリティのバランスを取りつつ対応してください。
