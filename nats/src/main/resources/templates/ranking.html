<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">

<head>
  <meta charset="UTF-8" />
  <title>Ranking</title>
  <style>
    table {
      border-collapse: collapse;
      width: 60%;
      margin: 20px auto;
    }

    th,
    td {
      border: 1px solid #ccc;
      padding: 8px;
      text-align: left;
    }

    th {
      background: #f2f2f2;
    }

    /* ★テーブル(ランキング)が背景色ベタになるのを改善：半透明にして背景画像が見えるようにする */
    table {
      background: rgba(255, 255, 255, 0.55);
      backdrop-filter: blur(4px);
      border-radius: 12px;
      overflow: hidden;
    }

    th {
      background: rgba(255, 255, 255, 0.75);
    }

    td {
      background: transparent;
      /* セル単位の白塗りを避ける */
    }

    /* ★自分の行をよりはっきり（太枠＋強めの背景＋影） */
    tr.me {
      outline: 4px solid rgba(45, 124, 255, 0.95);
      outline-offset: -2px;
      background: linear-gradient(90deg,
          rgba(45, 124, 255, 0.38),
          rgba(45, 124, 255, 0.16),
          rgba(45, 124, 255, 0.38));
      box-shadow: 0 10px 28px rgba(45, 124, 255, 0.28);
    }

    tr.me td {
      font-weight: 800;
    }

    /* ★順位バッジのベース（少し大きめに） */
    .rank-badge {
      font-weight: 900;
      font-size: 18px;
      letter-spacing: 0.5px;
    }

    /* ★金：グラデ＋発光 */
    .rank-gold {
      background: linear-gradient(180deg, #fff3a1 0%, #ffd24a 35%, #b8860b 100%);
      -webkit-background-clip: text;
      background-clip: text;
      color: transparent;
      text-shadow:
        0 0 6px rgba(255, 210, 74, 0.75),
        0 0 14px rgba(255, 210, 74, 0.45);
    }

    /* ★銀：金属っぽいグラデ */
    .rank-silver {
      background: linear-gradient(180deg, #ffffff 0%, #dfe3e8 45%, #8f9aa6 100%);
      -webkit-background-clip: text;
      background-clip: text;
      color: transparent;
      text-shadow:
        0 0 6px rgba(223, 227, 232, 0.75),
        0 0 14px rgba(143, 154, 166, 0.35);
    }

    /* ★銅：赤み＋光沢 */
    .rank-bronze {
      background: linear-gradient(180deg, #ffd2b0 0%, #c67a3a 45%, #7a3f1a 100%);
      -webkit-background-clip: text;
      background-clip: text;
      color: transparent;
      text-shadow:
        0 0 6px rgba(198, 122, 58, 0.65),
        0 0 14px rgba(122, 63, 26, 0.35);
    }

    .show-images-button {
      display: block;
      margin: 16px auto 0 auto;
      padding: 14px 28px;
      background: #2d7cff;
      color: #fff;
      border: none;
      border-radius: 28px;
      cursor: pointer;
      font-size: 18px;
      box-shadow: 0 6px 18px rgba(45, 124, 255, 0.25);
      transition: transform .12s ease;
    }

    .show-images-button:hover {
      transform: scale(1.04);
    }

    .show-images-button:active {
      transform: scale(1.00);
    }

    .hint {
      text-align: center;
      color: #666;
      margin-top: 8px;
      font-size: 14px;
    }

    body {
      background-image: url('/images/game-bg.png');
      background-size: cover;
      background-position: center;
      background-repeat: no-repeat;
      background-attachment: fixed;
    }

    /* 文字が読みにくい場合だけ薄い膜（濃さは調整OK） */
    body::before {
      content: '';
      position: fixed;
      inset: 0;
      background: rgba(255, 255, 255, 0.30);
      z-index: -1;
    }
  </style>
</head>

<body>
  <h1 style="text-align:center;">ランキング</h1>

  <button class="show-images-button" id="playAgainBtn" style="display:none;">もう一度遊ぶ</button>
  <div class="hint" id="playAgainHint" style="display:none;">※1Pのみ押せます</div>

  <table>
    <thead>
      <tr>
        <th>順位</th>
        <th>参加者</th>
        <th>タイム</th>
      </tr>
    </thead>
    <tbody id="rankingBody">
      <tr th:each="row, iterStat : ${rankings}">
        <td th:text="${iterStat.index + 1}"></td>
        <td th:text="${row.name}"></td>
        <td th:text="${row.formattedTime}"></td>
      </tr>
    </tbody>
  </table>

  <script>
    var POLL_STATUS_MS = 250;
    var POLL_RANKING_MS = 1000;
    var REDIRECT_LOBBY_URL = '/';

    async function fetchCurrentUser() {
      try {
        var r = await fetch('/api/online');
        var data = await r.json();
        return data ? data.currentUser : null;
      } catch (e) {
        console.error('online fetch failed (for highlight)', e);
        return null;
      }
    }

    function createRankSpan(rankNumber) {
      var sp = document.createElement('span');
      sp.className = 'rank-badge';

      if (rankNumber === 1) sp.classList.add('rank-gold');
      else if (rankNumber === 2) sp.classList.add('rank-silver');
      else if (rankNumber === 3) sp.classList.add('rank-bronze');

      sp.textContent = String(rankNumber);
      return sp;
    }

    async function renderRankings(rows) {
      var tbody = document.getElementById('rankingBody');
      if (!tbody) return;

      var currentUser = await fetchCurrentUser();

      tbody.innerHTML = '';
      (rows || []).forEach(function (row, idx) {
        var tr = document.createElement('tr');

        var rankNo = idx + 1;

        var tdRank = document.createElement('td');
        // ★1〜3位は色付きの数字
        tdRank.appendChild(createRankSpan(rankNo));

        var tdName = document.createElement('td');
        var name = (row && row.name != null) ? String(row.name) : '-';
        tdName.textContent = name;

        // ★自分の行ハイライト
        if (currentUser && name === currentUser) {
          tr.classList.add('me');
        }

        var tdTime = document.createElement('td');
        var ms = row && row.bestTimeMs != null ? Number(row.bestTimeMs) : null;
        if (ms == null || isNaN(ms)) {
          tdTime.textContent = '-';
        } else {
          var s = Math.floor(ms / 1000);
          var mm = Math.floor(s / 60);
          var ss = s % 60;
          var ms3 = ms % 1000;
          tdTime.textContent =
            String(mm).padStart(2, '0') + ':' +
            String(ss).padStart(2, '0') + '.' +
            String(ms3).padStart(3, '0');
        }

        tr.appendChild(tdRank);
        tr.appendChild(tdName);
        tr.appendChild(tdTime);
        tbody.appendChild(tr);
      });
    }

    async function updatePlayAgainVisibility() {
      try {
        var r = await fetch('/api/online');
        var data = await r.json();
        var users = (data && data.users) ? data.users : [];
        var currentUser = data ? data.currentUser : null;

        var is1P = false;
        if (users.length > 0 && currentUser && users[0] === currentUser) {
          is1P = true;
        }

        var btn = document.getElementById('playAgainBtn');
        var hint = document.getElementById('playAgainHint');
        if (btn) btn.style.display = is1P ? 'block' : 'none';
        if (hint) hint.style.display = is1P ? 'block' : 'none';
      } catch (e) {
        console.error('online fetch failed', e);
      }
    }

    function redirectToLobby() {
      try { localStorage.removeItem('gameStartTime'); } catch (e) { }
      window.location.href = REDIRECT_LOBBY_URL;
    }

    function startStatusPollingForRedirect() {
      setInterval(function () {
        fetch('/api/game/status')
          .then(function (res) { return res.json(); })
          .then(function (data) {
            if (!data) return;
            if (data.resetRequested === true) {
              redirectToLobby();
            }
          })
          .catch(function (err) {
            console.error('status poll failed', err);
          });
      }, POLL_STATUS_MS);
    }

    function startRankingAutoRefresh() {
      setInterval(function () {
        fetch('/api/rankings')
          .then(function (res) { return res.json(); })
          .then(function (rows) {
            // ★renderRankings が async になったので await する
            return renderRankings(rows);

          })
          .catch(function (err) {
            console.error('rankings fetch failed', err);
          });
      }, POLL_RANKING_MS);
    }

    document.addEventListener('DOMContentLoaded', function () {
      updatePlayAgainVisibility();
      setInterval(updatePlayAgainVisibility, 10000);

      startStatusPollingForRedirect();
      startRankingAutoRefresh();

      var btn = document.getElementById('playAgainBtn');
      if (btn) {
        btn.addEventListener('click', function () {
          btn.disabled = true;
          try { localStorage.removeItem('gameStartTime'); } catch (e) { }

          fetch('/api/game/reset', { method: 'POST' })
            .catch(function (err) {
              console.error('reset failed', err);
              btn.disabled = false;
            });
          // 2秒間 resetRequested=true なので、全員がそれぞれ検知して / に戻る
        });
      }
      playBgm('ranking.mp3');
    });

    // ===== BGM 関連 =====
    // ページごとに 1 つの BGM を管理するための Audio インスタンス
    var bgmAudio = null;

    /**
     * 指定されたファイル名の BGM をループ再生する
     * 例: playBgm('game.mp3') -> /bgm/game.mp3 を再生
     */
    function playBgm(bgmFileName) {
      // すでに再生中なら止める
      if (bgmAudio) {
        try {
          bgmAudio.pause();
        } catch (e) { }
        bgmAudio = null;
      }

      if (!bgmFileName) {
        return;
      }

      var src = '/bgm/' + bgmFileName;
      var audio = new Audio(src);
      audio.loop = true;

      // 自動再生ブロック対策: 再生エラーを握りつぶしてコンソールにだけ出す
      audio.play().catch(function (err) {
        console.warn('BGM 再生がブロックされました: ', err);
      });

      bgmAudio = audio;
    }

    /**
     * 現在の BGM を停止する
     */
    function stopBgm() {
      if (bgmAudio) {
        try {
          bgmAudio.pause();
        } catch (e) { }
        bgmAudio = null;
      }
    }
  </script>
</body>

</html>
